from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import yt_dlp
import os

# Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§ (Ù‡Ù†Ø´Ø±Ø­ Ø§Ø²Ø§ÙŠ ØªØ¬ÙŠØ¨Ù‡ Ø¨Ø¹Ø¯ Ø´ÙˆÙŠØ©)
TOKEN = "8400591391:AAGsL777YOiQ_cBBedPXR68SuTD8mD3kmHw"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸµğŸ¬\n"
        "Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ ØªÙŠÙƒ ØªÙˆÙƒ Ø£Ùˆ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…\n"
        "ÙˆØ£Ù†Ø§ Ø£Ø­Ù…Ù„ Ù„Ùƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„Ø£ØºÙ†ÙŠØ© ÙÙˆØ±Ø§Ù‹!\n\n"
        "Ù„Ùˆ Ø¹Ø§ÙŠØ² ØµÙˆØª ÙÙ‚Ø·: Ø§ÙƒØªØ¨ (ØµÙˆØª) Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·\n"
        "Ù…Ø«Ø§Ù„: ØµÙˆØª https://youtu.be/xxxx"
    )

async def handle_url(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    chat_id = update.message.chat_id
    
    await update.message.reply_text("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... Ø§Ù†ØªØ¸Ø± Ø´ÙˆÙŠØ© â³")

    url = text.replace("ØµÙˆØª", "").strip()

    try:
        if "ØµÙˆØª" in text.lower():
            # ØªØ­Ù…ÙŠÙ„ ØµÙˆØª ÙÙ‚Ø·
            ydl_opts = {
                'format': 'bestaudio/best',
                'outtmpl': '%(title)s.%(ext)s',
                'postprocessors': [{
                    'key': 'FFmpegExtractAudio',
                    'preferredcodec': 'mp3',
                    'preferredquality': '192',
                }],
            }
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                title = info.get('title', 'Ø£ØºÙ†ÙŠØ©')
                filename = f"{title}.mp3"
                
            await context.bot.send_audio(chat_id=chat_id, audio=open(filename, 'rb'), caption=title)
            os.remove(filename)
            
        else:
            # ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ
            ydl_opts = {'format': 'best[height<=720]', 'outtmpl': '%(title)s.%(ext)s'}
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                filename = ydl.prepare_filename(info)
                
            if os.path.getsize(filename) < 50*1024*1024:  # Ø£Ù‚Ù„ Ù…Ù† 50 Ù…ÙŠØºØ§
                await context.bot.send_video(chat_id=chat_id, video=open(filename, 'rb'), caption=info.get('title', 'ÙÙŠØ¯ÙŠÙˆ'))
            else:
                await context.bot.send_message(chat_id=chat_id, text="Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (>50MB) ğŸ˜”")
            os.remove(filename)
            
    except:
        await update.message.reply_text("Ø­ØµÙ„ Ø®Ø·Ø£.. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
app = Application.builder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_url))

print("Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø§Ù„Ø¢Ù†...")
app.run_polling()
